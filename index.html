<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Pro - Overall Stats</title>
    <style>
        :root {
            --accent: #00f2fe; --purple: #892fe2; --success: #00ff88;
            --danger: #ff0055; --warning: #f59e0b; --bg: #080808;
            --card-bg: rgba(255, 255, 255, 0.06);
        }

        body {
            background-color: var(--bg); color: white; font-family: 'Inter', sans-serif;
            margin: 0; min-height: 100vh;
            /* ANIMATED BACKGROUND */
            background: linear-gradient(125deg, #080808, #1a1a2e, #0d0d21, #080808);
            background-size: 400% 400%;
            animation: meshGradient 12s ease infinite;
            overflow-x: hidden;
        }

        @keyframes meshGradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* --- SPLASH SCREEN --- */
        #splash-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg); display: flex; flex-direction: column;
            align-items: center; justify-content: center; z-index: 1000;
        }
        .logo-box {
            width: 80px; height: 80px; background: linear-gradient(45deg, var(--accent), var(--purple));
            border-radius: 20px; display: flex; align-items: center; justify-content: center;
            font-size: 2.5rem; animation: pulse 2s infinite;
        }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }

        /* --- LAYOUT --- */
        .container { max-width: 480px; margin: auto; padding: 20px; padding-bottom: 120px; }
        .glass-card {
            background: var(--card-bg); backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 25px;
            padding: 20px; margin-bottom: 20px; position: relative;
        }

        /* --- OVERALL STATS CARD --- */
        .overall-card {
            background: linear-gradient(135deg, rgba(0, 242, 254, 0.1), rgba(137, 47, 226, 0.1));
            border: 1px solid var(--accent);
            text-align: center;
        }
        .overall-perc { font-size: 2.5rem; font-weight: 900; margin: 10px 0; background: linear-gradient(to right, var(--accent), var(--purple)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        /* --- PROFILE --- */
        .profile-header { display: flex; align-items: center; gap: 15px; margin-bottom: 25px; }
        #u-photo-display { width: 60px; height: 60px; border-radius: 15px; border: 2px solid var(--accent); object-fit: cover; background: #222; }
        .user-info-text h2 { margin: 0; font-size: 1.1rem; }
        .user-info-text p { margin: 2px 0; font-size: 0.75rem; color: var(--accent); }

        .photo-upload-label {
            width: 100px; height: 100px; border-radius: 50%; border: 2px dashed var(--accent);
            margin: 0 auto 15px; display: flex; align-items: center; justify-content: center;
            cursor: pointer; overflow: hidden; background: rgba(255,255,255,0.05);
        }
        #preview-img { width: 100%; height: 100%; object-fit: cover; display: none; }

        /* --- NAVIGATION --- */
        .nav-bar {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(20, 20, 20, 0.9); backdrop-filter: blur(20px);
            padding: 8px; border-radius: 50px; display: flex; gap: 8px;
            border: 1px solid rgba(255,255,255,0.1); z-index: 100;
        }
        .nav-btn {
            padding: 10px 20px; border-radius: 40px; border: none;
            color: #888; cursor: pointer; font-weight: bold; background: transparent;
        }
        .nav-btn.active { background: var(--accent); color: #000; }

        /* --- MARKS CENTER --- */
        .marks-row { display: grid; grid-template-columns: 1fr 1fr auto; gap: 8px; margin-top: 10px; }
        .marks-row input { padding: 8px; border-radius: 8px; font-size: 0.75rem; }
        .score-item { 
            display: flex; justify-content: space-between; padding: 8px 12px; 
            background: rgba(255,255,255,0.04); border-radius: 10px; margin-bottom: 6px; font-size: 0.85rem;
        }

        /* --- BUTTONS --- */
        .btn-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; }
        .action-btn { border: none; padding: 10px 0; border-radius: 10px; font-weight: bold; font-size: 0.65rem; cursor: pointer; }
        .btn-p { background: rgba(0, 255, 136, 0.1); color: var(--success); }
        .btn-a { background: rgba(255, 0, 85, 0.1); color: var(--danger); }
        .btn-b { background: rgba(245, 158, 11, 0.1); color: var(--warning); }
        .btn-u { background: rgba(255,255,255,0.05); color: #fff; }
        
        .del-btn { position: absolute; top: 15px; right: 15px; color: rgba(255,0,0,0.4); cursor: pointer; font-size: 0.8rem; border: none; background: none; }
        .del-btn:hover { color: var(--danger); }

        input { width: 100%; padding: 12px; margin: 6px 0; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; color: white; box-sizing: border-box; }
        .login-btn { width: 100%; padding: 15px; border-radius: 12px; border: none; background: linear-gradient(45deg, var(--accent), var(--purple)); color: white; font-weight: bold; margin-top: 10px; cursor: pointer; }
        .add-btn { background: none; border: 1px dashed var(--accent); color: var(--accent); width: 100%; padding: 12px; border-radius: 15px; cursor: pointer; margin-bottom: 20px; font-weight: bold; }

        /* --- WARNING POPUP --- */
        #warning-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 2000; backdrop-filter: blur(10px);
            align-items: center; justify-content: center;
        }
        .warning-box {
            background: #151515; border: 2px solid var(--danger); border-radius: 25px;
            padding: 30px; width: 80%; max-width: 320px; text-align: center;
            box-shadow: 0 0 30px rgba(255, 0, 85, 0.3);
        }
    </style>
</head>
<body>

<div id="splash-screen">
    <div class="logo-box">üìÖ</div>
    <h2 style="letter-spacing: 2px; margin-top: 20px;">STUDENT <span style="color:var(--accent)">PRO</span></h2>
</div>

<div id="warning-modal">
    <div class="warning-box">
        <div style="font-size: 3rem; margin-bottom: 10px;">‚ö†Ô∏è</div>
        <h2 style="color: var(--danger); margin: 0;">CRITICAL!</h2>
        <p id="warning-msg" style="font-size: 0.9rem; line-height: 1.5; margin: 15px 0; color: #ccc;"></p>
        <button onclick="closeWarning()" style="background: var(--danger); border: none; color: white; padding: 10px 25px; border-radius: 10px; font-weight: bold; cursor: pointer;">OKAY</button>
    </div>
</div>

<div class="container">
    <div id="login-screen">
        <div class="glass-card" style="text-align: center; margin-top: 20px;">
            <h1>Setup Profile</h1>
            <label class="photo-upload-label" for="photo-input">
                <span id="upload-icon">üì∏</span>
                <img id="preview-img" src="" alt="Preview">
            </label>
            <input type="file" id="photo-input" hidden accept="image/*" onchange="handlePhoto(this)">
            <input type="text" id="nameIn" placeholder="Full Name">
            <input type="text" id="rollIn" placeholder="Roll Number">
            <input type="text" id="secIn" placeholder="Section">
            <button class="login-btn" onclick="saveProfile()">LAUNCH DASHBOARD</button>
        </div>
    </div>

    <div id="app-screen" style="display: none;">
        <div class="profile-header">
            <img id="u-photo-display" src="" alt="User">
            <div class="user-info-text">
                <h2 id="u-name-display">Name</h2>
                <p id="u-detail-display">Roll ‚Ä¢ Section</p>
            </div>
            <button onclick="logout()" style="margin-left:auto; background:none; border:1px solid var(--danger); color:var(--danger); padding:4px 8px; border-radius:8px; font-size:0.6rem;">RESET</button>
        </div>

        <div id="attendance-section">
            <div class="glass-card overall-card" id="overall-stats-card">
                <p style="margin:0; font-size:0.8rem; color:var(--accent); font-weight:bold;">OVERALL ATTENDANCE</p>
                <div class="overall-perc" id="overall-perc-display">0%</div>
                <p id="overall-status-text" style="font-size:0.75rem; margin:0; opacity:0.8; line-height:1.4;">Add subjects to see status</p>
            </div>

            <button class="add-btn" onclick="addSubject()">+ Add New Subject</button>
            <div id="subject-list"></div>
        </div>

        <div id="marks-section" style="display: none;">
            <div id="marks-subject-list"></div>
        </div>
    </div>
</div>

<div class="nav-bar" id="app-nav" style="display: none;">
    <button class="nav-btn active" id="btn-att" onclick="switchTab('att')">Attendance</button>
    <button class="nav-btn" id="btn-marks" onclick="switchTab('marks')">Marks Center</button>
</div>

<script>
    let userProfile = JSON.parse(localStorage.getItem('at_profile_v4'));
    let subjects = JSON.parse(localStorage.getItem('at_subs_v4')) || [];
    let lastAction = []; 

    window.onload = () => {
        setTimeout(() => {
            document.getElementById('splash-screen').style.display = 'none';
            if(userProfile) renderApp();
        }, 2000);
    }

    function handlePhoto(input) {
        const file = input.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('preview-img').src = e.target.result;
                document.getElementById('preview-img').style.display = 'block';
                document.getElementById('upload-icon').style.display = 'none';
            };
            reader.readAsDataURL(file);
        }
    }

    function saveProfile() {
        const name = document.getElementById('nameIn').value;
        const roll = document.getElementById('rollIn').value;
        const sec = document.getElementById('secIn').value;
        const photo = document.getElementById('preview-img').src;
        if(!name || !roll) return alert("Details required!");
        userProfile = { name, roll, sec, photo };
        localStorage.setItem('at_profile_v4', JSON.stringify(userProfile));
        renderApp();
    }

    function renderApp() {
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('app-screen').style.display = 'block';
        document.getElementById('app-nav').style.display = 'flex';
        document.getElementById('u-name-display').innerText = userProfile.name;
        document.getElementById('u-detail-display').innerText = `${userProfile.roll} ‚Ä¢ ${userProfile.sec}`;
        if(userProfile.photo) document.getElementById('u-photo-display').src = userProfile.photo;
        updateUI();
    }

    function switchTab(tab) {
        document.getElementById('attendance-section').style.display = tab === 'att' ? 'block' : 'none';
        document.getElementById('marks-section').style.display = tab === 'marks' ? 'block' : 'none';
        document.getElementById('btn-att').classList.toggle('active', tab === 'att');
        document.getElementById('btn-marks').classList.toggle('active', tab === 'marks');
        if(tab === 'marks') renderMarks();
    }

    function mark(idx, type) {
        let s = subjects[idx];
        let oldPerc = s.t === 0 ? 100 : Math.round((s.p / s.t) * 100);

        // Get old overall percentage
        let totalP = 0, totalT = 0;
        subjects.forEach(sub => { totalP += sub.p; totalT += sub.t; });
        let oldOverall = totalT === 0 ? 100 : Math.round((totalP / totalT) * 100);

        if(type === 'u') {
            const history = lastAction.filter(a => a.idx === idx).pop();
            if(history && s.t > 0) {
                if(confirm(`Undo last action?`)) {
                    if(history.type === 'p') s.p--;
                    if(history.type === 'b') s.b--;
                    s.t--;
                    lastAction = lastAction.filter(a => a !== history);
                }
            }
        } else {
            if(type === 'p') { s.p++; s.t++; }
            if(type === 'a') { s.t++; }
            if(type === 'b') { s.t++; s.b++; }
            lastAction.push({idx, type});
        }

        // New Logic: Check Subject Warning
        let newPerc = s.t === 0 ? 100 : Math.round((s.p / s.t) * 100);
        if(newPerc < 75 && oldPerc >= 75) {
            showWarning(`Your attendance in <b>${s.name}</b> has dropped to <b>${newPerc}%</b>. Be careful!`);
        }

        // New Logic: Check Overall Warning
        let newTotalP = 0, newTotalT = 0;
        subjects.forEach(sub => { newTotalP += sub.p; newTotalT += sub.t; });
        let newOverall = newTotalT === 0 ? 100 : Math.round((newTotalP / newTotalT) * 100);
        
        if(newOverall < 75 && oldOverall >= 75) {
            showWarning(`<b>CRITICAL:</b> Your Overall Attendance is now <b>${newOverall}%</b>. It's below 75%!`);
        }

        saveData();
    }

    function showWarning(msg) {
        document.getElementById('warning-msg').innerHTML = msg;
        document.getElementById('warning-modal').style.display = 'flex';
    }

    function closeWarning() {
        document.getElementById('warning-modal').style.display = 'none';
    }

    function deleteSubject(idx) {
        if(confirm(`Delete "${subjects[idx].name}"?`)) {
            subjects.splice(idx, 1);
            saveData();
            renderMarks();
        }
    }

    function addSubject() {
        const n = prompt("Enter Subject Name:");
        if(n) { 
            subjects.push({name: n.toUpperCase(), p: 0, t: 0, b: 0, scores: []}); 
            saveData(); 
        }
    }

    function saveData() {
        localStorage.setItem('at_subs_v4', JSON.stringify(subjects));
        updateUI();
    }

    function updateUI() {
        const list = document.getElementById('subject-list');
        list.innerHTML = '';
        let totalP = 0, totalT = 0;
        subjects.forEach((s, i) => {
            totalP += s.p; totalT += s.t;
            const perc = s.t === 0 ? 0 : Math.round((s.p / s.t) * 100);
            const statusColor = perc < 75 ? 'var(--danger)' : 'var(--success)';
            list.innerHTML += `
                <div class="glass-card" style="border-left: 4px solid ${statusColor}">
                    <button class="del-btn" onclick="deleteSubject(${i})">üóëÔ∏è</button>
                    <div style="display:flex; justify-content:space-between; margin-bottom:8px; width:90%">
                        <b>${s.name}</b> <span style="color:${statusColor}">${perc}%</span>
                    </div>
                    <p style="font-size:0.7rem; color:#888; margin-bottom:12px;">P: ${s.p} / T: ${s.t} | Bunks: ${s.b}</p>
                    <div class="btn-grid">
                        <button class="action-btn btn-p" onclick="mark(${i},'p')">PRES</button>
                        <button class="action-btn btn-a" onclick="mark(${i},'a')">ABS</button>
                        <button class="action-btn btn-b" onclick="mark(${i},'b')">BUNK</button>
                        <button class="action-btn btn-u" onclick="mark(${i},'u')">UNDO</button>
                    </div>
                </div>`;
        });
        updateOverallStats(totalP, totalT);
    }

    function updateOverallStats(tp, tt) {
        const display = document.getElementById('overall-perc-display');
        const statusText = document.getElementById('overall-status-text');
        if (tt === 0) { display.innerText = "0%"; statusText.innerText = "Add attendance data to track progress."; return; }
        const overallPerc = Math.round((tp / tt) * 100);
        display.innerText = overallPerc + "%";
        display.style.color = overallPerc < 75 ? 'var(--danger)' : 'var(--success)';
        if (overallPerc >= 75) {
            let canBunk = 0, tempT = tt, tempP = tp;
            while (Math.floor((tempP / (tempT + 1)) * 100) >= 75) { canBunk++; tempT++; }
            statusText.innerHTML = `You are safe! You can bunk <b style="color:var(--success)">${canBunk}</b> more classes.`;
        } else {
            let needAttend = 0, tempT = tt, tempP = tp;
            while (Math.floor((tempP / tempT) * 100) < 75) { needAttend++; tempT++; tempP++; }
            statusText.innerHTML = `Low attendance! You need to attend <b style="color:var(--danger)">${needAttend}</b> more classes.`;
        }
    }

    function renderMarks() {
        const list = document.getElementById('marks-subject-list');
        list.innerHTML = subjects.length ? '' : '<p style="text-align:center; color:#555; margin-top:50px;">No subjects found.</p>';
        subjects.forEach((s, i) => {
            let scoresHtml = s.scores.map((sc, si) => `<div class="score-item"><span>${sc.title}: <b>${sc.score}</b></span><span onclick="removeScore(${i},${si})" style="color:var(--danger); cursor:pointer;">‚úï</span></div>`).join('');
            list.innerHTML += `<div class="glass-card">
                <button class="del-btn" onclick="deleteSubject(${i})">üóëÔ∏è</button>
                <h4 style="margin:0 0 10px 0; color:var(--accent); width:90%">${s.name}</h4>
                <div>${scoresHtml}</div>
                <div class="marks-row">
                    <input type="text" id="t-${i}" placeholder="Exam Title">
                    <input type="text" id="s-${i}" placeholder="Marks">
                    <button onclick="addScore(${i})" style="background:var(--success); border:none; border-radius:8px; padding:0 12px; color:#000; font-weight:bold; cursor:pointer;">+</button>
                </div>
            </div>`;
        });
    }

    function addScore(i) {
        const title = document.getElementById(`t-${i}`).value, score = document.getElementById(`s-${i}`).value;
        if(title && score) { subjects[i].scores.push({title, score}); saveData(); renderMarks(); }
    }

    function removeScore(subI, scoreI) { subjects[subI].scores.splice(scoreI, 1); saveData(); renderMarks(); }

    function logout() { if(confirm("Erase all data?")) { localStorage.clear(); location.reload(); } }
</script>
</body>
</html>